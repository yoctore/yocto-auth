/* yocto-auth - Yocto auth is an express middleware that permit an user to login it on an api, the module is based on passportJS - V1.0.4 */
function Auth(a){this.app={},this.dataCommon={},this.authmodel={},this.configs={},this.configs.standard=[],this.configs.ad=[],this.logger=a||logger}function bindStrategy(a,b){this.app.get(a.urls.connect,this.dataCommon.session,function(a,b,c){setUrlSession.apply(this,[a]),a.session.join={},_.isUndefined(a.params.id)||_.isEmpty(a.params.id)||_.isNull(a.params.id)||(a.session.join={id:a.params.id}),c()}.bind(this),passport.authenticate(b,"google"===b?{scope:a.scope}:{})),this.app.get(a.urls.callback,this.dataCommon.session,passport.authenticate(b,{failureRedirect:this.dataCommon.internalUrlRedirect+"?value="+encode('{"error":true,"provider":"'+b+'"}'),successRedirect:this.dataCommon.internalUrlRedirect+"?value="+encode('{"error":false,"provider":"'+b+'"}')}))}function encode(a){var b=utf8.encode(a);return base64.encode(b)}function decode(a){var b=base64.decode(a);return utf8.decode(b)}function setUrlSession(a){this.logger.debug("[ yocto-auth.setUrlSession ] - headers.referer value is : ",a.headers.referer);var b=url.parse(a.headers.referer);a.session.ecrm={urlRedirectSuccess:b.protocol+"//"+b.host+"/auth",urlRedirectFail:b.protocol+"//"+b.host+"/auth"},this.logger.debug("[ yocto-auth.setUrlSession ] - url was set in session, req.session = ",utils.obj.inspect(a.session))}var passport=require("passport"),FacebookStrategy=require("passport-facebook").Strategy,GoogleStrategy=require("passport-google-oauth").OAuth2Strategy,TwitterStrategy=require("passport-twitter").Strategy,_=require("lodash"),qs=require("qs"),logger=require("yocto-logger"),Strategy=require("passport-local").Strategy,signature=require("cookie-signature"),LdapStrategy=require("passport-ldapauth"),url=require("url"),base64=require("base-64"),utf8=require("utf8"),utils=require("yocto-utils");Auth.prototype.init=function(a,b,c){return _.isUndefined(a)||_.isNull(a)||_.isEmpty(a)||_.isUndefined(b)||_.isNull(b)||_.isEmpty(b)||_.isUndefined(c)||_.isNull(c)||_.isEmpty(c)?!1:(this.app=a,this.authmodel=b,this.dataCommon=c,a.use(passport.initialize()),passport.serializeUser(function(a,b){b(null,a)}),passport.deserializeUser(function(a,b){b(null,a)}),this.setEndPoint(),!0)},Auth.prototype.setEndPoint=function(){var a=function(a,b,c,d){this.logger.error('[ yocto-auth.endPoint ] error authentication for provider "'+b+'", more details : ',utils.obj.inspect(a)),d.redirect(c.session.ecrm.urlRedirectFail+"/fail?value="+encode('{"status":"error","code":"400101","message":"User not found for the given credentials"}'))}.bind(this);this.app.get(this.dataCommon.internalUrlRedirect,this.dataCommon.session,function(b,c){if(_.isUndefined(b.session.ecrm)||_.isUndefined(b.session.ecrm.urlRedirectFail)||_.isUndefined(b.session.ecrm.urlRedirectFail)){this.logger.error("[ yocto-auth.endPoint ] - an error occured when reading session, object ecrm was not defined, it seems that the session was reinitialized"),this.logger.debug("[ yocto-auth.endPoint ] - session that was in error : "+utils.obj.inspect(b.session));var d=url.parse(b.headers.referer);return c.redirect(d.protocol+"//"+d.host+"/auth/fail?value="+encode('{"status":"error","code":"400102","message":"An internal error occured, please retest to connect"}'))}var e={};try{if(e=qs.parse(b._parsedUrl.query),e=JSON.parse(decode(e.value)),e.error)throw{details:e.error,provider:e.provider};var f=utils.obj.camelizeKeys(b.session.passport.user),g={user:b.session.passport.user,provider:e.provider,paramToFind:{auth_type:e.provider,"social_profile.provider_id":f.providerId}};if("ad"===e.provider?g.paramToFind={auth_type:"active-directory","active_directory_profile.dn":b.session.passport.user.dn}:"standard"===e.provider&&(g.paramToFind={password:b.session.passport.user.password,$or:[{"login.email":b.session.passport.user.username},{"login.phone":b.session.passport.user.username}]}),_.isUndefined(b.session.join)||_.isNull(b.session.join)||_.isEmpty(b.session.join)){var h=this.configs[e.provider];_.isArray(h)&&(h=h[e.index]),this.authmodel[h.db.method](g).then(function(a){if(_.isEmpty(a))throw"User not found for this credentials.";b.session.passport.user=a,c.redirect(b.session.ecrm.urlRedirectSuccess+"/success?"+qs.stringify({session:"s:"+signature.sign(b.sessionID,this.dataCommon.secretCookieKey)}))}.bind(this))["catch"](function(d){a(d,e.provider,b,c)})}else this.authmodel.joinAccount(b.session.join.id,utils.obj.underscoreKeys({authType:e.provider,socialProfile:b.session.passport.user})).then(function(){this.logger.info('[ yocto-auth.endPoint ] - Document Auth created for account : "',b.session.join.id,'" for provider : "',e.provider,'"'),delete b.session.join,c.redirect(b.session.ecrm.urlRedirectSuccess+"/join/success?value="+encode('{"provider":"'+e.provider+'"}'))}.bind(this))["catch"](function(d){this.logger.error('[ yocto-auth.endPoint ] - error cannot create auth document for this social network "',d),b.session.ecrm.urlRedirectFail+="/join/fail?value="+encode('{"provider":"'+e.provider+'"}'),delete b.session.join,a(d,e.provider,b,c)}.bind(this))}catch(i){a(i.details,i.provider,b,c)}}.bind(this))},Auth.prototype.addTwitter=function(a){this.configs.twitter=a,passport.use(new TwitterStrategy({consumerKey:a.identifier,consumerSecret:a.secret,callbackURL:this.dataCommon.host+a.urls.callback},function(a,b,c,d){var e=utils.obj.underscoreKeys({providerId:c.id,displayName:c.displayName,profilePicture:_.isUndefined(_.first(c.photos))?"":_.first(c.photos).value,accessToken:a,secretToken:b});d(null,e)})),bindStrategy.apply(this,[a,"twitter"])},Auth.prototype.addStandard=function(a){this.configs.standard.push(a);var b=this.configs.standard.length-1;passport.use(new Strategy(function(a,b,c){c(null,{username:a,password:b})})),this.app.post(a.urls.connect,this.dataCommon.session,passport.authenticate("local",{failureRedirect:this.dataCommon.internalUrlRedirect+"?value="+encode('{"error":true,"provider":"standard","index":'+b+"}")}),function(a,c){return this.logger.debug("[ yocto-auth.addStandard.cb ] - value of req.session.passport.user = "+utils.obj.inspect(a.session.passport.user)),a.session.passport.user.error?(this.logger.error("[ yocto-auth.addStandard.cb ] - error when finding session,  more details : "+utils.obj.inspect(a.session.passport.user.error)),c.redirect(this.dataCommon.internalUrlRedirect+"?value="+encode('{"error":true,"provider":"standard","index":'+b+"}"))):(setUrlSession.apply(this,[a]),void c.redirect(this.dataCommon.internalUrlRedirect+"?value="+encode('{"error":false,"provider":"standard","index":'+b+"}")))}.bind(this))},Auth.prototype.addFacebook=function(a){this.configs.facebook=a,passport.use(new FacebookStrategy({clientID:a.identifier,clientSecret:a.secret,callbackURL:this.dataCommon.host+a.urls.callback,profileFields:a.fields},function(a,b,c,d){var e=utils.obj.underscoreKeys({providerId:c.id,displayName:c.displayName,lastname:c.name.familyName,firstname:c.name.givenName,sex:c.gender,profilePicture:_.isUndefined(_.first(c.photos))?"":_.first(c.photos).value,accessToken:a});d(null,e)})),bindStrategy.apply(this,[a,"facebook"])},Auth.prototype.addGoogle=function(a){this.configs.google=a,passport.use(new GoogleStrategy({clientID:a.identifier,clientSecret:a.secret,callbackURL:this.dataCommon.host+a.urls.callback},function(a,b,c,d){var e=utils.obj.underscoreKeys({providerId:c.id,displayName:c.displayName,lastname:c.name.familyName,firstname:c.name.givenName,sex:c.gender,profilePicture:_.isUndefined(_.first(c.photos))?"":_.first(c.photos).value,accessToken:a});d(null,e)})),bindStrategy.apply(this,[a,"google"])},Auth.prototype.addActiveDirectory=function(a){this.configs.ad.push(a);var b=this.configs.ad.length-1;passport.use(new LdapStrategy({server:a.server,usernameField:"username",passwordField:"display_password"},function(a,b){b(null,a)})),this.app.post(a.urls.connect,this.dataCommon.session,function(a,c,d){setUrlSession.apply(this,[a]),passport.authenticate("ldapauth",function(d,e){var f=JSON.stringify({error:!_.isNull(d),provider:"ad",index:b});a.session.passport={user:_.isNull(e)?{}:e},c.redirect(this.dataCommon.internalUrlRedirect+"?value="+encode(f))}.bind(this))(a,c,d)}.bind(this))},module.exports=function(a){return new Auth(a)};